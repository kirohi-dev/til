# 第二章

## リファクタリングの定義

### 名詞として

```
リファクタリング: 外部から見たときの振る舞いを保ちつつ、
理解や修正が簡単になるように、ソフトウェアの内部構造を変化させること。
```
### 動詞として

```
リファクタリングする: 一連のリファクタリングを適用して、
外部から見た振る舞いの変更なしに、ソフトウェアを再構築すること。
```

#### tips

- コード量を減らすのではなく、理解や修正がしやすくなることが重要。
- 小さなステップ繰り返して行くので、たとえ未完成でも、いつでも中断が可能。
- リファクタリング中に見つけたバグは、リファクタリング後も残っているべき。


## 二つの帽子

機能追加とリファクタリングは二つに区別すべき。
リファクタリング中は機能追加を行わない。

## リファクタリングを行うべき理由

- リファクタリングはソフトウェア設計を改善する
  - プログラムの内部設計(アーキテクチャ)の理解を助ける
  - 重複したコードを減らすことで、修正を楽にする
- リファクタリングはソフトウェアを理解しやすくする
  - 2,3ヶ月後にソースコードを読む人を軽視しがちだが、将来の開発者のことを考えないのは問題。
- バグの発見を助ける
- プログラミングを早める

## 計画されたリファクタリングと、機に応じたリファクタリング

リファクタリングは、if文を書くのに専用の時間を設けないのと同じように、プログラミングと不可分の作業。

## ブランチ

リファクタリングはコンフリクトを起こしやすい。
そのため、メインブランチとの統合を頻繁に行う必要がある。
そこでCIを導入する方がいい。

## リファクタリング

リファクタリングの安全性を高めるためにテストを導入した方が良い。

## データベースのリファクタリング

データベース・リファクタリングという本を参照。

## yangi

`you aren't going to need it`

たくさんの柔軟性が埋め込まれたシステムよりも、シンプルなシステムの方が変更がしやすい。

## リファクタリングと速度

### 早いソフトウェアを作る方法

- 実行スケジューリングを行う
  - 各コンポーネントに時間とメモリ使用量というリソースを割り振る
- パフォーマンスを常に意識するやり方
  - パフォーマンスを高めるためにあらゆる工夫をし続ける。広く一般的に行われている
- パフォーマンスチューニングに90%の法則を使う
  - パフォーマンスで興味深いのは、プログラムを解析してみると、ほとんどの時間がごく一部の処理に集中的に消費されているという事実。
  - コード全体にかけて最適化したコードのほとんどは無駄になる。
  - そこでリファクタリングをしてホットスポット（ボトルネック)を検出し、そこの改善へと集中する
  - ここでの作業も小さなステップを積み重ねていく。

#### tips

- 構文木: AST
- Coq
